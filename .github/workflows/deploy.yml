# name: Deploy Node.js with TypeScript on EC2

# on:
#     push:
#         branches:
#             - 'main'
#     pull_request:
#         branches:
#             - 'main'

# jobs:
#     build:
#         runs-on: ubuntu-latest

#         steps:
#             - uses: actions/checkout@v3

#             - name: Set up Node.js
#               uses: actions/setup-node@v3
#               with:
#                   node-version: '20.10.0'

#             - name: Install Dependencies
#               run: npm install --frozen-lockfile

#             - name: Install TypeScript Compiler
#               run: npm install -g typescript

#             - name: Build Project
#               run: npm run build

#     deploy:
#         runs-on: ubuntu-latest
#         needs: build

#         steps:
#             - uses: actions/checkout@v3

#             - name: Set up Node.js
#               uses: actions/setup-node@v3
#               with:
#                   node-version: '20.17'

#             - name: Install Dependencies
#               run: npm install --frozen-lockfile

#             - name: Build Project
#               run: npm run build

#             # Configure SSH access to the EC2 instance
#             - name: Configure SSH
#               env:
#                   SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }} # SSH key for access
#               run: |
#                   mkdir -p ~/.ssh
#                   echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
#                   chmod 600 ~/.ssh/id_rsa  # Set the correct permissions for the private key
#                   ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts  # Add the EC2 host to known hosts

#             # Install PM2 on EC2 (with sudo if necessary)
#             - name: Install PM2 on EC2
#               run: |
#                   ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo npm install -g pm2"  # Add sudo to PM2 installation

#             # Deploy the backend application to EC2 (this is where we create the 'backend' folder)------------
#             - name: Deploy Backend to EC2
#               env:
#                   EC2_HOST: ${{ secrets.EC2_HOST }} # EC2 Host URL or IP address
#                   EC2_USER: ${{ secrets.EC2_USER }} # EC2 SSH username (e.g., ubuntu)
#                   ENV_VARS_JSON: ${{ secrets.ENV_VARS_JSON }} # Pass the environment variables JSON
#               run: |
#                   # Create application directories on EC2 if they don't exist
#                   ssh $EC2_USER@$EC2_HOST "mkdir -p ~/applications/backend"

#                   # Copy the backend project to EC2 using `rsync`
#                   rsync -avz \
#                     --exclude='.git' \
#                     --exclude='node_modules' \
#                     --exclude='.github' \
#                     . $EC2_USER@$EC2_HOST:~/applications/backend/  # Deploy only the backend files

#                   # Install production dependencies on EC2 for the backend
#                   ssh $EC2_USER@$EC2_HOST "cd ~/applications/backend && npm install --frozen-lockfile --production"

#                   # Set the environment variables (using the ENV_VARS_JSON secret)
#                   # ssh $EC2_USER@$EC2_HOST "echo '$ENV_VARS_JSON' > ~/applications/backend/.env"
#                   ssh $EC2_USER@$EC2_HOST "echo '$ENV_VARS_JSON' | jq -r 'to_entries | .[] | \"\(.key)=\(.value)\"' > ~/applications/backend/.env"

#                   # Stop the existing PM2 process if it exists
#                   ssh $EC2_USER@$EC2_HOST "pm2 delete backend || true"  # Ensures no errors if the process doesn't exist

#                   # Start the backend application with PM2
#                   ssh $EC2_USER@$EC2_HOST "cd ~/applications/backend && pm2 start dist/server.js --name backend"

name: Deploy Node.js + Redis on EC2 with Docker

on:
    push:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              run: |
                  docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/podcast-backend:latest .
                  docker push ${{ secrets.DOCKERHUB_USERNAME }}/podcast-backend:latest

            - name: Deploy to EC2
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  EC2_USER: ${{ secrets.EC2_USER }}
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  ENV_VARS_JSON: ${{ secrets.ENV_VARS_JSON }}
              run: |
                  mkdir -p ~/.ssh
                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
                    
                  ssh $EC2_USER@$EC2_HOST "sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/podcast-backend:latest"
                  ssh $EC2_USER@$EC2_HOST "sudo docker ps -q -f name=redis-prod || sudo docker run -d --name redis-prod -p 6379:6379 --restart unless-stopped redis:latest"
                  ssh $EC2_USER@$EC2_HOST "sudo docker rm -f podcast-backend || true"
                  ssh $EC2_USER@$EC2_HOST "sudo docker run -d --name podcast-backend -p 5090:5090 --env-file ~/applications/backend/.env ${{ secrets.DOCKERHUB_USERNAME }}/podcast-backend:latest"

# #With redis password authentication
# # name: Deploy Node.js + Redis on EC2 with Docker

# # on:
# #   push:
# #     branches:
# #       - main

# # jobs:
# #   build-and-deploy:
# #     runs-on: ubuntu-latest

# #     steps:
# #       - uses: actions/checkout@v3

# #       - name: Set up Docker Buildx
# #         uses: docker/setup-buildx-action@v2

# #       - name: Log in to DockerHub
# #         uses: docker/login-action@v2
# #         with:
# #           username: ${{ secrets.DOCKERHUB_USERNAME }}
# #           password: ${{ secrets.DOCKERHUB_TOKEN }}

# #       - name: Build and push Docker image
# #         run: |
# #           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/backend-app:latest .
# #           docker push ${{ secrets.DOCKERHUB_USERNAME }}/backend-app:latest

# #       - name: Deploy to EC2
# #         env:
# #           SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
# #           EC2_USER: ${{ secrets.EC2_USER }}
# #           EC2_HOST: ${{ secrets.EC2_HOST }}
# #           ENV_VARS_JSON: ${{ secrets.ENV_VARS_JSON }}
# #         run: |
# #           mkdir -p ~/.ssh
# #           echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
# #           chmod 600 ~/.ssh/id_rsa
# #           ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

# #           # Create backend app directory and write .env file
# #           ssh $EC2_USER@$EC2_HOST "mkdir -p ~/applications/backend"
# #           ssh $EC2_USER@$EC2_HOST "echo '$ENV_VARS_JSON' | jq -r 'to_entries | .[] | \"\(.key)=\(.value)\"' > ~/applications/backend/.env"

# #           # Ensure redis.conf exists on EC2 (you must upload this manually once or via separate step)
# #           # For example: requirepass YourStrongPasswordHere + optional config

# #           # Check if Redis container is running; if not, start with password config
# #           ssh $EC2_USER@$EC2_HOST "docker ps -q -f name=redis-prod || docker run -d --name redis-prod -p 6379:6379 --restart unless-stopped \
# #             -v ~/applications/backend/redis.conf:/usr/local/etc/redis/redis.conf \
# #             redis:latest redis-server /usr/local/etc/redis/redis.conf"

# #           # Remove old backend container if exists
# #           ssh $EC2_USER@$EC2_HOST "docker rm -f backend-app || true"

# #           # Run backend container with updated image and env file
# #           ssh $EC2_USER@$EC2_HOST "docker run -d --name backend-app -p 5090:5090 --env-file ~/applications/backend/.env ${{ secrets.DOCKERHUB_USERNAME }}/backend-app:latest"
